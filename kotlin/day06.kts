val mapString: String = "..#....##....................#...#...#..........................................................................................#.|.....#..............................................#....#.....#.....#..............................#.......#...#.............#...|............#.#.........................................#...................#..#...........................###..........#.....#...|.....#.....#.............#...........................................................#.#.................#.........#..............|.......................#...........................#................#...........#......#.....................#...#.......#....#...|...#........................................#....................#.......#........##.##.........#.........................#.......|......#...........#....................#...........#.............................#........................#....................#..|...........................#...................................#...............#.........................................#........|........#...........#................................................................#............#...............................|.........................#......#.......#..............#......#.................#..................#...................#..........|............#......................................................#..............................#........#....#.................|........#.....................................................................#..............#....................................|..#............................#.................#.#............#.................................................................|...#................#.....................#.................................................#...................#.................|......#...................#........................................................................................#..#...........|.....................##..#........................................#...................#............#.....#........................|.......#.................#..........#...........................#.......#..............#..........................................|.............#........#........#..........#................#.........#.##.................................#.......#...........#...|.#..............................................................#..#.....................................#.................##.....|.........................#.#.......#.#..................................................#....................#.......#.........#..|.............#................................................#..#................#.............#.....#...........................|.............................................#..............#.....#..............#.........#......................................|................#............#............................#...........#.#.........................................................|...#.................................#.......#.........................................#..........................................|...............................#.....................................................................#.....#.........##...........|...................#...................................#.....................#.............................#..#...#...............|......#.......................................................#............................#......#.................#.#...........|...........................................#........................#.........#........................##......#..................|....#.......................#...................#.....#....................#......................................................|.....#......#....#..........#............#........#...............................................................................|.........#.................................................................................#........#.........................#...|........................#................................#........#...#......#........#..........#.#.......#.........#.........#.#|.##......#..#......#............#.#.................................#..............................#.........#....................|......#..............................#..........#.........#.....#....................................#...........................#|..#.........................#.#...#............................................#.#.......................................##.......|#.........................#......................#.............#..#.#...#....#.....#.#...#......#........................#........|.#............................#.................................#....#..............................#........#..........#.........|..........#.........#.....#.....#......................#............................................#.............................|.........................#...#.............................#..............................................#......#.#..............|....................#................................................................................................#............|...#........#......................#..#...........#..#.........#.................................................#................|...................#....................#..............#......................#..............#........#......................#....|.............#..................................................................................#................#.....##.........|.#.............................#........#................#..#..#.....#...........###..............................................|.......................................................#.........................#.............................#..................|...........................##.............#.........................................................#.......................#.....|......#.......##.........#..................................................................#.#..#.........#.........#.......#....|..#...........#..........#........#....#..........#..................#.............#.............#................................|#................................##...........#......#....##......#..#.....................................#.........#..#.........|...#...#.#.......................#......................................#.........#......#...............#........................|..#...#.......................................................#..................#.........................................#......|...#.....#.....#..........#....................#..................#.........................#...............#...#..#....#.........|..........#................................#...................#..#...........#.........#....................................#....|..............#........#............................#..................................................................#........#.|............................................................#.....##.................................#............................|...##..............................................#..........................................#.............................#.##..|...#...........................................................................#......#.....................#.#...................|.........#.............................................................................##.....................................#.#.|...............#.....#........#..#................................................................................................|#...........................#.#..............................#........^......#.................................#.....#............|...#...#.........................................#......................#.#.......................................................|.#......#...........................#.............................................................................................|.....#.........#.......#..#........#.....#.....................#......#........................................#...#..............|....#....................................................................................................#........................|#..............#.......................#.........................................#...............................#.#..............|................................#..............................#.......................................................#....#.....|....#............................#............................................................#.....#........#...................#|...........#...#............................#....................#.......................................................#........|.#.....................................................................................................#.....#....................|.#.......#..............#.....................#.....................#............#........................#.......................|............................#...#................................................#................................#...............|..........#...............#..........................#................#.........................#.......#.#.......................|..............................#.............................................................................................#.....|..............................................#....#...............................................#.....#........................|.........#...................................................#...............#.....#................#.............................|...........................................#..............#....................................................#........#.#.......|..........................#...........#.#...#.....................................#......................#...........#..#.........|....#...............#..............#.............................#....#.....#....#................................................|....#.#...........#..............#.................................................................#..............................|.....#.......#..........................................................................................#.#.......................|................................................#..#..............................................................................|.#....#..............................#..........#................#.............................................................#..|....#.......................#........#.....#..............#...............#..#........................................#...........|...........................................................................#......................................................|...#.........#..#.......................................................#..#..............................#.......................|.............#...................................................................#.......................#...#...........#........|.....#........................#....................#...................#................................#.........................|.........#......#...........................................#.......#....................#........................................|...........................................................#...........................#.............................#............|..........................#..............#........................................#......#.........#.#.............#........#.....|.........#..............#..#...........................#......#.......................#..#..#.............#.......................|...#.................#...............................................................................................#............|................#.....#.#...........................#......................#....................................#...#.#...........|..................#.....#...............................................................#............................#....#..#....|...............................#................................................#.............#..........................#........|..#...........#................................................#.........................................#...............##......#|...............................#..................##..#...........................................#................#..............|...........................#........#.........#....................................................#......#......#................|..................................#................#..................#.....#..................#...................#.....#........|.......#...#................................................................##...........................................#........|..............#..#.......#............................#...................#....#...........................#..#......#............|...............#............#................................................................................#..............#.....|...............#.....#........................#.........#.........#...#................#....#.........#...........................|................................#........................................................................#.........#..............|.............#..................#...#................................#..............#................................#.........#..|.....................#.#.............................#......#..................................#.........##....#.................#|......#.........#...#.................................#..........#.#......................#.......#........#......................|.....#....................#......................#.........#.....................#.........................................#......|.........##.....................#....#.#....#....................................................................................#|.................................................#.#....#....................#...............##..#................................|..##.......#........#.......................#.....................................................................#...........#.##|..#...........##........##......#..........#....................#.....#.....#..................#.....#............................|..........................#.......................#.....#.........................................................................|.#...........................#..............#...#...........#.....#.......#....#............#.....#..................#....#......#|.................#.......................#....#...#..................#......#............................#.....................#..|.....##..#........#........................#......#........................#....#......................##.........................|...#....................................................................................................#.......................#.|.......................#...#..............#..................#............#.#.........#....#...#..................................|...........#.......................#.......................#.......#....#.....#..................#...................#............|..................#......................................................................#.......#..........................#.....|.......#..................#.............#..#........##........#..##........##.....##...#................#..#.......#..............|........#................#..............................#..#......................................................................|...................#....#.........................#...........#.#......##.........#.#..................#..#.#....#........#.......|.............#......#.....................................................#.......................................................|.........................#.......................#..................#.........................#...............................#..#|..#...........................#............#.................##...#................#.................#................#...........|.....#...............#.....#..........#..................................#.#........................#.....###.#...................|...............................................#.............#......................................................#.............|......#......................#..............#.................#.#........#.................#......................................|........................#.......................................#....................#.......#.#..#..............................."

class Coordinate(val char: Char) {
    var n: Coordinate? = null
    var e: Coordinate? = null
    var w: Coordinate? = null
    var s: Coordinate? = null
}

fun createCoords(map: List<List<Char>>): List<List<Coordinate>> {
    val mutList: MutableList<MutableList<Coordinate>> = mutableListOf()

    for (i in map.indices) {
        val row: MutableList<Coordinate> = mutableListOf()
        mutList.add(row)
        for (j in map[i].indices) {
            val coord = Coordinate(map[i][j])
            if (i-1 in mutList.indices) {
                coord.n = mutList[i-1][j]
                coord.n!!.s = coord
            }
            if (j-1 in row.indices) {
                coord.w = row[j-1]
                coord.w!!.e = coord
            }
            mutList[i].add(coord)
        }
    }

    return mutList
}

// Returns null if infinite loop is detected
fun getGuardPath(coords: List<List<Coordinate>>): Set<Coordinate>? {
    val path = mutableSetOf<Coordinate>()

    var location: Coordinate = coords.flatten().find { it.char == '^' }!!
    var direction = Coordinate::n

    var step = 0
    val stepLimit = coords.flatten().size * 4 // Map size times number of directions

    while (true) {
        path.add(location)

        val next: Coordinate? = direction(location)

        if (next == null) {
            return path
        } else if (next.char == '#') {
            direction = when (direction) {
                Coordinate::n -> Coordinate::e
                Coordinate::e -> Coordinate::s
                Coordinate::s -> Coordinate::w
                Coordinate::w -> Coordinate::n
                else -> Coordinate::n
            }
        } else {
            location = next
            if (++step > stepLimit) {
                return null
            }
        }
    }
}

val problem1Solution: Int = mapString
    .split('|')
    .map { it.toList() }
    .let(::createCoords)
    .let(::getGuardPath)!!
    .size
    .also(::println)

val problem2Solution: Int = mapString
    .mapIndexed { i, char -> if (char == '.') "${mapString.slice(0..i-1)}#${mapString.slice(i+1..<mapString.length)}" else mapString }
    .count {
        it.split('|').map { it.toList() }.let(::createCoords).let(::getGuardPath) == null
    }
    .also(::println)
